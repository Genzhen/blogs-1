<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Get rect point</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      padding: 0;
    }
    header {
      height: 300px;
      margin: 16px auto;
    }
    article {
      width: 1280px;
      margin: 0 auto;
      display: flex;
    }
    aside {
      width: 346px;
      border: 1px solid #dddddd;
      margin-left: 16px;
      padding: 8px;
    }
    footer {
      height: 52px;
      line-height: 52px;
      text-align: center;
    }
    .mainBox {
      width: 1264px;
      border: 1px solid #dddddd;
      margin: 16px auto;
      padding: 8px;
    }
    .content{
      width: 900px;
      height: 700px;
      overflow: auto;
    }
    .rect {
      position:absolute;
      width: 0px;
      height: 0px;
      font-size: 0px;
      margin: 0px;
      padding: 0px;
      border: 1px dashed #0099FF;
      background-color:rgba(195, 213, 237, .6);
      z-index: 1000;
      opacity: 0.6;
    }
    .linkRect{
      display: inline-block;
      margin:0px;
      padding:0px;
      position: absolute;
      cursor: pointer;
      z-index: 9;
      border: 1px dashed #0099FF;
      background-color: rgba(195, 213, 237, .6);
      text-decoration: none;
    }
    .linkRect .resize {
      display: inline-block;
      position: absolute;
      height: 6px;
      width: 6px;
      right: -3px;
      bottom: -3px;
      cursor: nwse-resize;
      background-color: #3C9DD0;
    }
    .hotLinks {
      display: inline-block;
      position: relative;
      background-image: url('./images/background.png');
      background-size: cover;
    }
    .hotLinks.mobilebc {
      background-image: url('./images/mobileBC.jpeg');
    }

    /* Moema */
    .button-moema {
      border-radius: 4px;
      color: #fff;
    }
    .button-moema::before {
      content: '';
      position: absolute;
      top: -20px;
      left: -20px;
      bottom: -20px;
      right: -20px;
      background: inherit;
      border-radius: 50px;
      z-index: -1;
      opacity: 0.4;
      -webkit-transform: scale3d(0.8, 0.5, 1);
      transform: scale3d(0.8, 0.5, 1);
    }
    .button-moema:hover {
      color: #e95924;
      border: 1px dashed #e95924;
      -webkit-animation: anim-moema-1 0.5s ease-in-out;
      animation: anim-moema-1 0.5s ease-in-out;
    }
    .button-moema:hover::before {
      -webkit-animation: anim-moema-2 0.5s 0.3s ease-in-out;
      animation: anim-moema-2 0.5s 0.3s ease-in-out;
    }
    @keyframes anim-moema-1 {
      60% {
        -webkit-transform: scale3d(0.8, 0.8, 1);
        transform: scale3d(0.8, 0.8, 1);
      }
      85% {
        -webkit-transform: scale3d(1.1, 1.1, 1);
        transform: scale3d(1.1, 1.1, 1);
      }
      100% {
        -webkit-transform: scale3d(1, 1, 1);
        transform: scale3d(1, 1, 1);
      }
    }
    @keyframes anim-moema-2 {
      to {
        opacity: 0;
        -webkit-transform: scale3d(1, 1, 1);
        transform: scale3d(1, 1, 1);
      }
    }
  </style>
</head>
<body>
  <header class="mainBox">
    This is header
  </header>
  <!-- 中间内容 -->
  <article>
    <!-- 背景图 -->
    <section class="content">
      <!-- 热点 -->
      <div class="hotLinks">
        <img src="./images/background.png" alt="background-image" />
      </div>
    </section>
    <aside>
      This is aside
    </aside>
  </article>
  <footer class="mainBox">
    <button class="changebc" type="button">Change mobile image</button>
    <button class="savePoints" type="button">Save</button>
  </footer>
  
  <script>
    (function() { 
      // @hasRectSelect 是否可以框选
      // @op 框选框原来的坐标信息
      var hasRectSelect = false, hasMoving = false, hasResize = false, selRect, op = {}, startX, startY, _x, _y;
      var content = document.querySelector('.content');
      var hot = document.querySelector('.hotLinks');
      var hotW = 0, hotH = 0;   // hot容器的宽高
      var cbtn = document.querySelector('.changebc');
      var saveBtn = document.querySelector('.savePoints');
      
      // 切换pc和mobile背景图
      cbtn.onclick = function(){
        hot.insertAdjacentHTML('beforeend', '<img src="./images/mobileBC.jpeg" alt="mobile-image" />');
        hot.classList.add('mobilebc');
        document.querySelector('.hotLinks img').onload = handleHotSize;
      };
      
      // 保存坐标信息到localStorage
      saveBtn.onclick = function() {
        var temp = Array.from(document.querySelectorAll('.linkRect')).map(ele => {
          return {
            x: ele.dataset['px'],
            y: ele.dataset['py'],
            w: ele.dataset['pw'],
            h: ele.dataset['ph']
          }
        });
        localStorage.setItem('rectPoints', JSON.stringify(temp));
      };
      
      // 节流防抖
      function debounce(fn, interval) {
        var timer = null;

        function delay() {
          var target = this;
          var args = arguments;
          return setTimeout(function () {
            fn.apply(target, args);
          }, interval);
        }

        return function () {
          if (timer) {
            clearTimeout(timer);
          }

          timer = delay.apply(this, arguments);
        }
      };

      // 背景图容器相对DOM起点的偏移
      var getOffsetInfo = function() {
        return {
          x: content.offsetLeft,
          y: content.offsetTop,
          sx: content.scrollLeft,
          sy: content.scrollTop
        };
      };
      
      // 获取坐标和长宽信息
      var getPointInfo = function(s) {
        return {
          x: parseInt(s.left),
          y: parseInt(s.top),
          w: parseInt(s.width),
          h: parseInt(s.height)
        };
      };
      
      // 缓存坐标和长宽信息
      var cachePointInfo = function(ele, o) {
        ele.setAttribute('data-px', o.x);
        ele.setAttribute('data-py', o.y);
        ele.setAttribute('data-pw', o.w);
        ele.setAttribute('data-ph', o.h);
      };

      // 判断拖拽是否溢出
      // @con 容器的宽高信息
      // @cur 当前鼠标的坐标信息
      var hasOverflow = function(con, cur) {
        return cur.x >= 0 && cur.y >= 0 && cur.x + cur.w <= con.w && cur.y + cur.h <= con.h;
      };
      
      // 渲染框选框
      var renderRect = function(o) {
        var link = document.createElement('a');
        var span = document.createElement('span');
        var offsetInfo = getOffsetInfo();
        span.className = 'resize';
        link.style.cssText = `width: ${o.w}px;height: ${o.h}px;left: ${o.x - offsetInfo.x + offsetInfo.sx}px; top: ${o.y - offsetInfo.y + offsetInfo.sy}px;`;
        link.className = "linkRect";
        link.text = '';
        link.appendChild(span);
        link.setAttribute('data-href', 'https://www.google.com/' + document.querySelectorAll('.linkRect').length);
        hot.appendChild(link);
        cachePointInfo(link, getPointInfo(link.style));
        link = null;
        span = null;
      };
      
      // 设定hot容器的宽高
      var handleHotSize = function(){
        hot.style.width = this.width + 'px';
        hot.style.height = this.height + 'px';
        hotW = this.width;
        hotH = this.height;
        hot.removeChild(this);
      };

      document.querySelector('.hotLinks img').onload = handleHotSize;

      hot.onmousedown = function (e) {
        var ele = e.target;
        // 区分缩放和移动框选框
        if (ele.className.indexOf('resize') > -1)
          hasResize = ele.parentElement;
        else if (ele.className.indexOf('hotLinks') > -1)
          hasRectSelect = true;
        else if (ele.className.indexOf('linkRect') > -1)
          hasMoving = ele;
        startX = e.pageX;   // 初始化坐标
        startY = e.pageY;
        if (hasMoving || hasResize) {
          op.x = parseInt(hasMoving ? hasMoving.style.left : hasResize.style.left);
          op.y = parseInt(hasMoving ? hasMoving.style.top : hasResize.style.top);
          op.w = parseInt(hasMoving ? hasMoving.style.width : hasResize.style.width);
          op.h = parseInt(hasMoving ? hasMoving.style.height : hasResize.style.height);
        }
        e.stopPropagation();
      };

      document.onmousemove = debounce(function(e) { 
        if (hasRectSelect || hasMoving || hasResize) {
          _x = e.pageX;
          _y = e.pageY;
        }
        if (hasMoving || hasResize) {
          var mx = _x - startX;   // x轴移动距离
          var my = _y - startY;   // y轴移动距离
        }
        if (hasRectSelect) {  // 画框选框
          var w = Math.abs(_x - startX);  // x轴移动距离的绝对值
          var h = Math.abs(_y - startY);  // y轴移动距离的绝对值
          if (w < 3 || h < 3) return;   // 优化性能，避免鼠标误点
          if (!selRect) {
            selRect = document.createElement("div");
            selRect.className = "rect";
            document.body.appendChild(selRect);
          }
          var minx = Math.min(_x, startX);
          var miny = Math.min(_y, startY);
          if (!hasOverflow({ w: hotW, h: hotH }, { x: minx, y: miny, w: w, h: h })) return;
          selRect.style.left = minx + "px";
          selRect.style.top = miny + "px";
          selRect.style.width = w + "px";
          selRect.style.height = h + "px"; 
        } else if (hasMoving) {  // 任意移动框选框
          var mvstyle = hasMoving.style;
          if (!hasOverflow({ w: hotW, h: hotH }, { x: op.x + mx, y: op.y + my, w: parseInt(mvstyle.width), h: parseInt(mvstyle.height) })) {
            return;
          }
          hasMoving.style.left = op.x + mx + "px";
          hasMoving.style.top = op.y + my + "px";
        } else if (hasResize) {  // 缩放框选框
          var restyle = hasResize.style;
          if (!hasOverflow({ w: hotW, h: hotH }, { x: parseInt(restyle.left), y: parseInt(restyle.top), w: op.w + mx, h: op.h + my })) return;
          hasResize.style.width = op.w + mx + "px";
          hasResize.style.height = op.h + my + "px";
        }
        e.stopPropagation();
      }, 8);

      document.onmouseup = function(e) { 
        if (selRect && hasRectSelect) { 
          var s = selRect.style;
          var info = getPointInfo(s);
          renderRect(info);
          document.body.removeChild(selRect);
        } else if (hasMoving || hasResize) {
          var ele = hasMoving || hasResize;
          var o = getPointInfo(ele.style);
          cachePointInfo(ele, o);
        } 
        hasRectSelect = false;
        hasMoving = false;
        hasResize = false;
        _x = null, _y = null, selRect = null, startX = null, startY = null, op = {};
      };
   })(); 
  </script>
</body>
</html>