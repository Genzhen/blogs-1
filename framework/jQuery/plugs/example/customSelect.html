<!DOCTYPE>
<html>
<head>
    <title>自定义下拉框</title>
    <style media="screen">
      .content {
        width: 280px;
        max-height: 300px;
        min-height: 36px;
        padding: 4px 2px;
        margin: 0;
        border: 1px solid #ccc;
        border-radius: 5px;
        overflow: auto;
      }
      .content li{
        display: inline-block;
        position: relative;
        list-style: none;
        padding: 2px 0px 2px 16px;
        border: 1px solid #ccc;
        border-radius: 5px;
        margin: 3px 6px;
        background-color: #e4e4e4;
        color: #666;
        font-size: 14px;
        white-space: nowrap;
      }
      .content li .before{
        display: inline-block;
        position: absolute;
        width: 14px;
        height: 28px;
        top: 0;
        left: -14px;
      }
      .content li .close{
        display: inline-block;
        height: 24px;
        width: 24px;
        line-height: 24px;
        text-align: center;
        color: #999;
        cursor: pointer;
      }
      .content li.input{
        padding: 0;
        outline: none;
        border: none;
      }
      .content li.input input{
        outline: none;
        font-size: 13px;
      }
      .hidden-input {
        border: none;
        width: 32px;
        padding: 6px;
        height: 32px;
        display: inline-block;
      }
      .insert-items {
        width: 280px;
        max-height: 300px;
        position: absolute;
        top: 75px;
        z-index: 9;
        background: #fff;
        border: 1px solid #aaa;
        box-shadow: 2px 3px 3px rgba(0, 0, 0, 0.11);
        border-radius: 3px;
        overflow: hidden;
        padding: 2px;
        margin: 0;
        overflow: auto;
      }
      .insert-items li {
        cursor: pointer;
        padding: 2px 16px;
        border-radius: 3px;
        margin: 4px 0;
        list-style: none;
        line-height: 24px;
        white-space: nowrap;
      }
      .insert-items li:hover{
        background-color: #ddd;
      }
      .insert-items li.selected {
        background-color: #64b6ff;
        color: #fff;
      }
    </style>
    <script src="http://apps.bdimg.com/libs/jquery/1.9.1/jquery.js" type="text/javascript"></script>
</head>
<body>

<div class="" style="position:relative;">
  <ul class="content" contenteditable="true">

  </ul>

  <ul class="insert-items" style="display: none;">

  </ul>
</div>

<script type="text/javascript">
  $(document).ready(function () {
    var currentRequest = null;
    $("input[name='q']").focus();

    $('body').on('keyup', '.content .input', function(){
      requestData($(this).val(), './queryLabelsByName.json', '.insert-items');
    });

    $('body').click(function(){
      $('.content .input').remove();
      $('.insert-items').hide();
    });

    $('body').on('click', '.content li:not(.input) .before,.content', function(event){
      event.stopPropagation();
      $('.content .input').remove();
      if($(this).hasClass('content')){
        $('<li class="input"><input class="hidden-input" type="text" /></li>').appendTo(this).find('input').focus();
      } else {
        $('<li class="input"><input class="hidden-input" type="text" /></li>').insertBefore(this).find('input').focus();
      }
    });

    $('body').on('click', '.content .close', function(event){
      event.stopPropagation();
      $(this).parent().remove();
    });

    $('.insert-items').on('click', 'li', function(){
      if($(this).hasClass('selected')) return;
      $('.content .input').replaceWith($(this.outerHTML).append('<span class="close">x</span><span class="before"></span>'));
      $('.insert-items').hide();
    });

    function requestData(name, url, container){
      $('.insert-items').html('loading...');
      currentRequest = jQuery.ajax({
        url: url,
        type: 'POST',
        data: {name: name},
        beforeSend: function()    {
          if(currentRequest != null) {
            currentRequest.abort();
          }
        },
        success: function(res) {
          if(res) {
            var str = '',
              selectedItem = $('.content li').map(function(k, ele){
                return $(ele).data('id');
              }).toArray();
            for(var i = 0, l = res.length; i < l; i++){
              var item = res[i], selected = '';
              for(var j = 0, len = selectedItem.length; j < len; j++){
                if(item.id === selectedItem[j]){
                  selected = 'selected';
                }
              }
              str += '<li class="' + selected + '" data-id="' + item.id + '">' + (item.name || item.text) + '</li>';
            }
            $(container).html(str).show().css('top', $(container).prev()[0].clientHeight + 2);
          }
        }
      });
    }
  });
</script>
</body>
</html>
