## node_modules依赖包目录

* 模块安装过程

  - 发出npm install命令
  - npm 向 registry 查询模块压缩包的网址
  - 下载压缩包，存放在~/.npm目录
  - 解压压缩包到当前项目的node_modules目录  

  备注：一个模块安装以后，本地其实保存了两份。一份是~/.npm目录下的压缩包（缓存），另一份是node_modules目录下解压后的代码。  

* 缓存目录

  npm install 或 npm update命令，从 registry 下载压缩包之后，都存放在本地的缓存目录（~/.npm）。window下则在%AppData%/npm-cache 目录下。

* 从缓存中安装依赖包

  --cache-min 参数指定一个时间（单位为分钟），只有超过这个时间的模块，才会从 registry 下载。

  `npm install --cache-min [9999999|Infinity] <package-name>`

* 命令行包目录 - node_modules/.bin

  node_modules/.bin 目录，保存了依赖目录中所安装的可供调用的命令行包。

  npm 执行 install 时，会分析每个依赖包的 package.json 中的 bin 字段，并将其包含的条目安装到 ./node_modules/.bin 目录中，文件名为 <command>，此文件是指向对应依赖包的命令的符号链接。

  ![bin目录下的软链接](../images/bin.png)

## npm 模块安装机制

  安装之前，npm install会先检查，node_modules目录之中是否已经存在指定模块。如果存在，就不再重新安装了，即使远程仓库已经有了一个新版本，也是如此。

  -- registry   指定安装依赖包镜像地址
  -f or --force   不管是否安装过，都要强制重新安装

  * 安装原理

  **npm 2** 在安装依赖包时，采用简单的递归安装方法。每一个包都有自己的依赖包，自己的依赖都安装在了自己的 node_modules 目录下。依赖关系层层递进，构成了一棵依赖树。`npm ls`命令可以查看这棵完整的依赖树。这样的树形结构优缺点都很明显。

  优点是结构清晰，便于手动管理；缺点是层级过深，重复安装等问题。

  **npm 3** 的 node_modules 目录改成了更加扁平状的层级结构。在安装时遍历整个依赖树，npm会默认在无冲突的前提下，尽可能将包安装到较高的层级，使得所有被重复依赖的包都可以去重安装。另外，需要注意的是，同层不能有两个同名子目录，所以同名但版本不同的包会安装在不同的层级。因此，依赖树结构不再与文件夹层级一一对应了，查看完整的依赖树，需要使用命令`npm ls --depth`。

  当然，npm3 也可以使用传统递归树的模式，使用命令 `npm install --global-style`。

  **npm 5** 增加了 package-lock.json 文件，用于锁定依赖安装结构，这个json文件的结构和依赖包层级结构是一一对应的。这样做的好处就是，安装幂等性。

  当然，也有人觉得package-lock.json文件太复杂，也可以禁用掉此功能 `npm config set package-lock false`。

  **npm 6** 目前的最新版本，npm@6 致力于将安全性放在首要位置，并帮助开发人员构建全球最具可扩展性的关键任务 JavaScript 应用程序。

  当开发人员尝试使用具有已知漏洞的开源代码时，它可以自动发出警告。npm 命令'npm audit'，可以允许开发人员分析复杂的代码并查明特定的漏洞。

  任何时候有人提交了 package.json, package-lock.json 更新后，团队其他成员应在 svn update/git pull 拉取更新，然后执行 npm install 脚本安装更新后的依赖包。

## npm config

* 指定npm模块下载为第三方镜像地址

  用户目录下的.npmrc文件（/Users/cycle263/.npmrc）, `registry=https://registry.npm.taobao.org`, 或者`npm config set registry https://registry.npm.taobao.org`

  window下文件地址：`nodejs安装目录/node_modules/npm/.npmrc`

* 修改全局安装模块地址

  用户目录下的.npmrc文件（`~/.npmrc 或者 /Users/cycle263/.npmrc`）, `prefix=/Users/npm_modules`

* 优质的镜像地址

  ```json
  alibaba: http://registry.npm.alibaba-inc.com
  npm: https://registry.npmjs.org/
  cnpm: http://r.cnpmjs.org/
  taobao: http://registry.npm.taobao.org/
  edunpm: http://registry.enpmjs.org/
  eu: http://registry.npmjs.eu/
  au: http://registry.npmjs.org.au/
  sl: http://npm.strongloop.com/
  nj: https://registry.nodejitsu.com/
  pt: http://registry.npmjs.pt/
  ```