<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>MediaDevices</title>
    <style media="screen">
      .record-block{text-align: center;background-color: #1b1b1b;padding: 16px;position: fixed;top: 0;left: 0;bottom: 0;right: 0;width: 100%;height: 100%;}
      #contents{position: relative;z-index: 1;}
      .operate-block{width: 100%;position: absolute;bottom: 36px;left: 0;padding: 32px 16px;z-index: 2;}
      #record-gif{width: 800px;height:80px;visibility: hidden;position: absolute;left:50%;bottom: 12px;margin-left: -400px;z-index: 9;}
      #recordBtn{padding: 8px 32px;border-radius: 4px;margin-right: 16px;position: relative;z-index: 11;background-color: transparent;color: white;font-size: 16px;}
    </style>
  </head>
  <body>
    <div class="record-block">
      <ul id="contents"></ul>
      <div class="operate-block">
        <img id="record-gif" src="../../../../framework/React/images/siri.gif" />
        <button id="recordBtn" class="button">按住说话</button>
        <audio id="recordAudio" autoplay="true"></audio>
      </div>
    </div>

    <script src="../../scripts/recorder.js" type="text/javascript"></script>
    <script type="text/javascript">
      // 纯html5 api
      (function(window){
        window.URL = window.URL || window.webkitURL;
        navigator.getUserMedia  = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
        var recordBtn = document.querySelector('#recordBtn');
        var audio = document.querySelector('#recordAudio');
        var gif = document.querySelector('#record-gif');
        var audioRecorder = null;
        var audioContext = new AudioContext();
        var uploadAudio = function(url, audioBlob, callback){
          if(!url || !audioBlob) return;
          console.log('blog size: ', audioBlob.size / 1024 + 'k');
          var fd = new FormData();
          fd.append("audioData", audioBlob);
          var xhr = new XMLHttpRequest();
          xhr.upload.addEventListener("progress", function (e) {
              console.log('上传完成了：' + e.loaded * 100 / e.total + '%');
          }, false);
          xhr.addEventListener("load", function (e) {
              alert('上传成功！');
          }, false);
          xhr.open("POST", url);
          xhr.send(fd);
        }

        recordBtn.addEventListener('mousedown', function(){
          gif.style.visibility = 'visible';
          navigator.mediaDevices.getUserMedia({audio: true})
          .then(function(mediaStream){
            var mediaStreamSource = audioContext.createMediaStreamSource(mediaStream);   // 媒体流音频源
            audioRecorder = new Recorder(mediaStreamSource, {numChannels: 1, sampleRate: 16 * 1024});    // numChannels=1为单声道，sampleRate：采样率
            audioRecorder.record();
          }).catch(function(err){
            console.error(err);
          });
        });
        recordBtn.addEventListener('mouseup', function(){
          gif.style.visibility = 'hidden';
          audioRecorder.stop();
          audioRecorder.exportWAV(function(audioBlob){
            audio.src = window.URL.createObjectURL(audioBlob);
            uploadAudio('//jsonplaceholder.typicode.com/posts/', audioBlob)
          });
        });
      })(window);
    </script>
  </body>
</html>
