<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width">
  <title>read wav file</title>
  <link rel="stylesheet" href="">
  <style>
    button {
      padding: 5px 8px;
      cursor: pointer;
    }
  </style>
  <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
  <h1>read wav file</h1>
  <audio id="sound" src="./test.mp3" controls="controls"></audio>
  <button id="btn1">Read Wav and make noise</button>
  <button id="btn2">Read Wav and play audio</button>
  <p id="progress"></p>
</body>
<script>
  var playButton1 = document.getElementById('btn1');
  var playButton2 = document.getElementById('btn2');
  var progress = document.getElementById('progress');

  // Create AudioContext and buffer source
  var audioCtx = new AudioContext();
  var source = audioCtx.createBufferSource();

  // Create a ScriptProcessorNode with a bufferSize of 4096 and a single input and output channel
  var scriptNode = audioCtx.createScriptProcessor(4096, 1, 1);
  console.log(scriptNode.bufferSize);

  // load in an audio track via XHR and decodeAudioData
  function getData() {
    request = new XMLHttpRequest();
    request.open('GET', 'like you.wav', true);
    request.responseType = 'arraybuffer';
    request.onload = function () {
      var audioData = request.response;
      audioCtx.decodeAudioData(audioData, function (buffer) {
        myBuffer = buffer;
        console.log('myBuffer', myBuffer);
        source.buffer = myBuffer;
        source.loop = true;
      }, function (e) {
        console.error("Error with decoding audio data" + e.err)
      });
    }
    request.onprogress = function(event) {
      if (event.lengthComputable) {
        var percentComplete = (event.loaded / event.total * 100).toFixed(2);
        var percentText = 'Read wav file completion progress: ' + percentComplete + '%';
        progress.innerHTML = percentText;
      }
    }
    request.send();
  }

  // Give the node a function to process audio events
  scriptNode.onaudioprocess = function (audioProcessingEvent) {
    // The input buffer is the song we loaded earlier
    var inputBuffer = audioProcessingEvent.inputBuffer;
    // The output buffer contains the samples that will be modified and played
    var outputBuffer = audioProcessingEvent.outputBuffer;

    // Loop through the output channels (in this case there is only one)
    for (var channel = 0; channel < outputBuffer.numberOfChannels; channel++) {
      var inputData = inputBuffer.getChannelData(channel);
      var outputData = outputBuffer.getChannelData(channel);

      // Loop through the 4096 samples
      for (var sample = 0; sample < inputBuffer.length; sample++) {
        // make output equal to the same as the input
        console.log(inputData[sample])
        outputData[sample] = inputData[sample];
        // add noise to each output sample
        // outputData[sample] += ((Math.random() * 2) - 1) * 0.2;
      }
    }
  }

  getData();

  // wire up play button
  playButton1.onclick = function () {
    source.connect(scriptNode);
    scriptNode.connect(audioCtx.destination);
    source.start();
  }

  // When the buffer source stops playing, disconnect everything
  source.onended = function () {
    source.disconnect(scriptNode);
    scriptNode.disconnect(audioCtx.destination);
  }
</script>

</html>